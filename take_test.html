{% extends "base.html" %}

{% block title %}Тест: {{ test.title }} - Фишинговый Тренажер{% endblock %}

{% block content %}
<div class="container">
    <div class="test-header">
        <h1>{{ test.title }}</h1>
        <p>{{ test.description }}</p>
        
        <div class="test-info">
            <div class="info-item">
                <strong>Сложность:</strong>
                <span class="difficulty-badge difficulty-{{ test.difficulty }}">
                    {% if test.difficulty == 'beginner' %}Начинающий
                    {% elif test.difficulty == 'intermediate' %}Средний
                    {% else %}Продвинутый
                    {% endif %}
                </span>
            </div>
            <div class="info-item">
                <strong>Вопросов:</strong>
                <span>{{ test.questions|length }}</span>
            </div>
            {% if test.time_limit > 0 %}
            <div class="info-item">
                <strong>Лимит времени:</strong>
                <span>{{ test.time_limit }} минут</span>
            </div>
            {% endif %}
        </div>
    </div>

    <form id="testForm">
        <div class="questions-container">
            {% for question in test.questions %}
            <div class="question-card" data-question-id="{{ question.id }}">
                <div class="question-header">
                    <h3>Вопрос {{ loop.index }}</h3>
                    <span class="points">{{ question.points }} балл(ов)</span>
                </div>
                
                <p class="question-text">{{ question.question_text }}</p>
                
                <div class="options-container">
                    {% if question.question_type == 'single_choice' %}
                        {% for option in question.options %}
                        <div class="option">
                            <input type="radio" 
                                   id="q{{ question.id }}_o{{ loop.index0 }}" 
                                   name="q{{ question.id }}" 
                                   value="{{ loop.index0 }}">
                            <label for="q{{ question.id }}_o{{ loop.index0 }}">{{ option }}</label>
                        </div>
                        {% endfor %}
                    {% else %}
                        {% for option in question.options %}
                        <div class="option">
                            <input type="checkbox" 
                                   id="q{{ question.id }}_o{{ loop.index0 }}" 
                                   name="q{{ question.id }}" 
                                   value="{{ loop.index0 }}">
                            <label for="q{{ question.id }}_o{{ loop.index0 }}">{{ option }}</label>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="test-actions">
            <button type="button" id="submitTest" class="btn btn-primary">Завершить тест</button>
            <div id="timer" class="timer">
                {% if test.time_limit > 0 %}
                Время: <span id="timeDisplay">00:00</span>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<div id="resultsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Результаты теста</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="resultsContent">
                <!-- Results will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button id="closeResults" class="btn">Закрыть</button>
            <a href="{{ url_for('tests_list') }}" class="btn btn-primary">К списку тестов</a>
        </div>
    </div>
</div>

<script>
let timeSpent = 0;
let timerInterval;

document.addEventListener('DOMContentLoaded', function() {
    startTimer();
    
    document.getElementById('submitTest').addEventListener('click', submitTest);
    document.querySelector('.close').addEventListener('click', closeModal);
    document.getElementById('closeResults').addEventListener('click', closeModal);
});

function startTimer() {
    timerInterval = setInterval(() => {
        timeSpent++;
        updateTimerDisplay();
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeSpent / 60);
    const seconds = timeSpent % 60;
    document.getElementById('timeDisplay').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function submitTest() {
    if (!confirm('Вы уверены, что хотите завершить тест? После отправки изменить ответы будет невозможно.')) {
        return;
    }
    
    clearInterval(timerInterval);
    
    const formData = new FormData(document.getElementById('testForm'));
    const answers = {};
    
    document.querySelectorAll('.question-card').forEach(questionCard => {
        const questionId = questionCard.dataset.questionId;
        const questionType = document.querySelector(`input[name="q${questionId}"]`).type;
        
        if (questionType === 'radio') {
            const selected = document.querySelector(`input[name="q${questionId}"]:checked`);
            answers[questionId] = selected ? parseInt(selected.value) : null;
        } else {
            const selected = Array.from(document.querySelectorAll(`input[name="q${questionId}"]:checked`))
                                .map(input => parseInt(input.value));
            answers[questionId] = selected.length > 0 ? selected : null;
        }
    });
    
    fetch(`/test/{{ test.id }}/submit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            answers: answers,
            time_spent: timeSpent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResults(data);
        } else {
            alert('Ошибка при отправке теста: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка соединения');
    });
}

function showResults(data) {
    const resultsContent = document.getElementById('resultsContent');
    const percentage = data.percentage;
    
    let resultClass = 'result-excellent';
    if (percentage < 60) resultClass = 'result-poor';
    else if (percentage < 80) resultClass = 'result-average';
    else if (percentage < 90) resultClass = 'result-good';
    
    resultsContent.innerHTML = `
        <div class="result-summary ${resultClass}">
            <div class="result-score">${percentage}%</div>
            <div class="result-text">
                <p>Вы набрали ${data.score} из ${data.max_score} баллов</p>
                <p>Время выполнения: ${Math.floor(timeSpent / 60)}:${(timeSpent % 60).toString().padStart(2, '0')}</p>
            </div>
        </div>
        <div class="result-message">
            <p>Результат сохранен в вашем профиле. Прогресс обучения обновлен.</p>
        </div>
    `;
    
    document.getElementById('resultsModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('resultsModal').style.display = 'none';
}

window.addEventListener('click', function(event) {
    const modal = document.getElementById('resultsModal');
    if (event.target === modal) {
        closeModal();
    }
});
</script>
{% endblock %}